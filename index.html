<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aadi Kanban</title>
  <style>
    :root { --bg:#0b1020; --card:#151b2e; --muted:#8ea0c9; --text:#eaf0ff; --accent:#6ea8fe; --done:#34c759; }
    * { box-sizing: border-box; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin: 0; background: linear-gradient(120deg,#0b1020,#111b36); color: var(--text); }
    header { padding: 16px 20px; border-bottom: 1px solid #273457; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    h1 { margin:0; font-size: 18px; }
    .muted { color: var(--muted); font-size: 13px; }
    button, input, select { background:#1c2542; color:var(--text); border:1px solid #334579; border-radius:10px; padding:10px 12px; min-height:40px; }
    button { cursor:pointer; }
    main { display:grid; grid-template-columns: repeat(4, minmax(230px,1fr)); gap:14px; padding:14px; min-height: calc(100vh - 80px); }
    .col { background: rgba(21,27,46,.85); border:1px solid #2e3d66; border-radius:14px; padding:10px; display:flex; flex-direction:column; }
    .col h2 { margin:2px 0 10px; font-size:14px; display:flex; justify-content:space-between; align-items:center; }
    .dropzone { min-height:120px; display:flex; flex-direction:column; gap:8px; }
    .card { background:#1a2240; border:1px solid #334579; border-radius:10px; padding:10px; cursor:grab; }
    .focus-card { border: 2px solid #f6c453; box-shadow: 0 0 0 2px rgba(246,196,83,.2), 0 0 18px rgba(246,196,83,.25); }
    .card:active { cursor:grabbing; }
    .card .meta { margin-top:6px; display:flex; justify-content:space-between; align-items:center; font-size:11px; color:var(--muted); }
    .badge { padding:2px 8px; border-radius:999px; font-size:11px; border:1px solid #455b94; }
    .high { color:#ffd38b; border-color:#8a6b34; }
    .other { color:#b6cffb; }
    .done { color:#9ff0b2; border-color:#2b8a3e; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; }
    .mobile-tabs { display:none; gap:6px; width:100%; overflow:auto; padding-bottom:2px; }
    .mobile-tabs button { white-space:nowrap; min-height:36px; padding:8px 10px; }
    .mobile-tabs .active { border-color:#6ea8fe; box-shadow:0 0 0 1px rgba(110,168,254,.35); }
    .drag-over { outline:2px dashed var(--accent); outline-offset:3px; border-radius:10px; }
    .drop-before { box-shadow: inset 0 3px 0 0 #6ea8fe; }
    .drop-after { box-shadow: inset 0 -3px 0 0 #6ea8fe; }
    @media (max-width: 1000px){ main{ grid-template-columns: repeat(2,minmax(220px,1fr)); } }
    @media (max-width: 640px){ 
      header { position: sticky; top: 0; z-index: 20; background: rgba(11,16,32,.96); backdrop-filter: blur(6px); }
      .toolbar input { width: 100%; }
      main{ grid-template-columns: 1fr; padding:10px; gap:10px; }
      .col h2 { font-size: 15px; }
      .card { padding:12px; }
      .mobile-tabs { display:flex; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Kev x Aadi â€” Local Kanban</h1>
    <span class="muted">Drag tasks across columns. Auto-saves in this browser.</span>
    <div class="toolbar">
      <input id="newTask" placeholder="Add new task..." size="34" />
      <select id="newPriority">
        <option value="high">High</option>
        <option value="other">Other</option>
      </select>
      <button id="addBtn">Add</button>
      <button id="resetBtn">Reset to current task list</button>
      <button id="exportBtn">Export JSON</button>
      <button id="importBtn">Import JSON</button>
      <button id="pullGitBtn">Pull GitHub Live</button>
      <button id="pushGitBtn">Push Live to GitHub</button>
      <span id="gitStatus" class="muted">GitHub sync idle</span>
    </div>
    <div id="focusBanner" style="width:100%; margin-top:8px; padding:10px 12px; border-radius:12px; border:1px solid #4b3a12; background:linear-gradient(90deg,#2b2108,#3a2d0b); color:#ffe29a; font-weight:700;"></div>
    <div id="mobileTabs" class="mobile-tabs"></div>
  </header>

  <main id="board"></main>

  <script>
    const STORAGE_KEY = 'aadi-kanban-v2';
    const GITHUB_TOKEN_KEY = 'aadi-kanban-github-token';
    const GITHUB_OWNER = 'Aadi161';
    const GITHUB_REPO = 'aadi-kanban-board';
    const GITHUB_BRANCH = 'main';
    const GITHUB_DATA_PATH = 'kanban-data.json';
    const AUTO_PULL_MS = 15000;
    const REMOTE_FINGERPRINT_KEY = 'aadi-kanban-remote-fp';

    const columns = [
      { id:'backlog', name:'Backlog' },
      { id:'high', name:'High Priority' },
      { id:'progress', name:'In Progress' },
      { id:'done', name:'Done' }
    ];

    const defaultTasks = [
      { "id": "gouthamapp1", "text": "Reply to Goutham and send email to appraisers based on Gouthamâ€™s feedback.", "priority": "high", "col": "high", "createdAt": 1771353300000 },
      { "id": "veereshi20", "text": "Send I-20 to Veeresh", "priority": "high", "col": "done", "createdAt": 1771142400000 },
      { "id": "1o7hxp53", "text": "Reply to Ambiga and accordingly provide direction to Daniel (Kroll)", "priority": "high", "col": "done", "createdAt": 1771141829327 },
      { "id": "1rzi4ppz", "text": "Send email to Kartheek Reddy giving him an update on Tapestry.", "priority": "high", "col": "done", "createdAt": 1771141711149 },
      { "id": "1kxzsnow", "text": "Send reply to Josh Worden and full scope of work.", "priority": "high", "col": "high", "createdAt": 1771141711149 },
      { "id": "0st0kmxs", "text": "Finalize appraisal - reply to Daniel, and then reply to Ambiga.", "priority": "high", "col": "done", "createdAt": 1771141711149 },
      { "id": "bm8omef0", "text": "Reply to Mike Scanlon about funding.", "priority": "high", "col": "high", "createdAt": 1771141711149 },
      { "id": "gpocp9wp", "text": "Reply to Tom about Leslie / sales position items.", "priority": "high", "col": "done", "createdAt": 1771141711149 },
      { "id": "qlx2ytex", "text": "Send AMEX receipts to Steph.", "priority": "high", "col": "high", "createdAt": 1771141711149 },
      { "id": "9610jo11", "text": "Reach out to Valerie about our homes.", "priority": "high", "col": "high", "createdAt": 1771141711149 },
      { "id": "f155a7be", "text": "Set up marketing meeting for Windmills USA.", "priority": "high", "col": "high", "createdAt": 1771141711149 },
      { "id": "aqr8shro", "text": "TE Digital Transformation - request team input on tools, bottlenecks, repetitive tasks, and desired automation.", "priority": "high", "col": "high", "createdAt": 1771141711149 },
      { "id": "cgxfgf3b", "text": "Reach out to Andi Palacios - Hospitality exec, Mexico City experience.", "priority": "high", "col": "done", "createdAt": 1771141711149 },
      { "id": "cr7xdkcy", "text": "Funding for future phase land - lot sales.", "priority": "high", "col": "high", "createdAt": 1771141711149 },
      { "id": "emmaind01", "text": "Plan Emmaâ€™s induction - schedule & employment paperwork.", "priority": "high", "col": "high", "createdAt": 1771260800000 },
      { "id": "manikdesign1", "text": "Send response to Manik and team on design sign off for Kush Saxena.", "priority": "high", "col": "high", "createdAt": 1771372800000 },
      { "id": "stephcoit1", "text": "Reply to Stephanie on geotech for Coit vistas.", "priority": "high", "col": "high", "createdAt": 1771372800001 },
      { "id": "h1bbuild1", "text": "H-1B - reach out to immigration lawyers & The Build Fellowship.", "priority": "high", "col": "high", "createdAt": 1771522200000 },
      { "id": "harrisburg1", "text": "Pay fees for Harrisburg University", "priority": "high", "col": "high", "createdAt": 1771523400000 },
      { "id": "stephappraisal1", "text": "Respond to Stephâ€™s email about appraisal on future phase property.", "priority": "high", "col": "high", "createdAt": 1771524000000 },
      { "id": "cashpayables1", "text": "Check payables incoming + current cash available.", "priority": "high", "col": "high", "createdAt": 1771524600000 },
      { "id": "marblevilla21", "text": "Make sure marble has been paid for and shipped for Villa 2.", "priority": "high", "col": "high", "createdAt": 1771524600001 },
      { "id": "szwmbexw", "text": "Update and send termination agreement to Bailey Brothers.", "priority": "other", "col": "backlog", "createdAt": 1771141711149 },
      { "id": "z4aafom6", "text": "Send email regarding Windmills to Kamal and Ashish (chef Suresh feedback + menu/space changes).", "priority": "other", "col": "backlog", "createdAt": 1771141711149 },
      { "id": "qy7voqhy", "text": "Review Villa 28 listing and send details for Villa 2 to be listed (2nd Priority).", "priority": "other", "col": "backlog", "createdAt": 1771141711149 },
      { "id": "hdj5ey8o", "text": "Tell Christy about the hours for Tapestry model home.", "priority": "other", "col": "backlog", "createdAt": 1771141711149 },
      { "id": "ktv92lb8", "text": "Come up with a plan for graphic design; speak with Kamal re: Kashvi & others.", "priority": "other", "col": "backlog", "createdAt": 1771141711149 },
      { "id": "prhzgjml", "text": "Reach out to Bijoy Shetty through Sanjith about Music Foundation vids.", "priority": "other", "col": "backlog", "createdAt": 1771141711149 },
      { "id": "d92se31g", "text": "Send email to Kamal about Salesforce issues and requirements.", "priority": "other", "col": "backlog", "createdAt": 1771141711149 }
    ];

    function uid(){ return Math.random().toString(36).slice(2,10); }

    function initialState(){
      return defaultTasks.map(t => ({...t, id: t.id || uid()}));
    }

    let tasks = JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null') || initialState();
    let mobileColumn = 'high';
    let draggedTaskId = null;
    const DRAG_ENABLED = true; // drag/drop between columns enabled; arrows for in-column reordering

    function isMobile(){ return window.innerWidth <= 640; }

    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks)); }

    function getFocusTask(){
      return tasks.find(t => t.col === 'high') || null;
    }

    function renderMobileTabs(){
      const tabs = document.getElementById('mobileTabs');
      tabs.innerHTML = '';
      columns.forEach(c => {
        const b = document.createElement('button');
        b.textContent = c.name;
        if (mobileColumn === c.id) b.classList.add('active');
        b.onclick = () => { mobileColumn = c.id; render(); };
        tabs.appendChild(b);
      });
    }

    function render(){
      const board = document.getElementById('board');
      board.innerHTML = '';

      const focus = getFocusTask();
      const focusBanner = document.getElementById('focusBanner');
      focusBanner.textContent = focus
        ? `ðŸ”¥ FOCUS NOW: ${focus.text}`
        : 'âœ… No tasks in High Priority right now.';

      renderMobileTabs();
      const visibleCols = isMobile() ? columns.filter(c => c.id === mobileColumn) : columns;

      visibleCols.forEach(col => {
        const el = document.createElement('section');
        el.className = 'col';
        const items = tasks.filter(t => t.col === col.id);
        el.innerHTML = `<h2>${col.name} <span class="muted">${items.length}</span></h2><div class="dropzone" data-col="${col.id}"></div>`;
        const dz = el.querySelector('.dropzone');
        items.forEach(t => dz.appendChild(card(t, focus)));

        if (DRAG_ENABLED) {
          dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('drag-over'); });
          dz.addEventListener('dragleave', () => dz.classList.remove('drag-over'));
          dz.addEventListener('drop', e => {
            e.preventDefault(); dz.classList.remove('drag-over');
            const id = e.dataTransfer.getData('text/plain') || draggedTaskId;
            if (id) moveTask(id, col.id, null, 'end');
            draggedTaskId = null;
          });
        }

        board.appendChild(el);
      });
    }

    function moveTask(draggedId, targetCol, targetId = null, position = 'end') {
      const fromIndex = tasks.findIndex(t => t.id === draggedId);
      if (fromIndex < 0) return;

      const [dragged] = tasks.splice(fromIndex, 1);
      dragged.col = targetCol;

      let insertIndex = tasks.length;

      if (targetId) {
        const targetIndex = tasks.findIndex(t => t.id === targetId);
        if (targetIndex >= 0) {
          insertIndex = position === 'after' ? targetIndex + 1 : targetIndex;
        }
      } else {
        // append to end of target column
        const indices = tasks
          .map((t, i) => (t.col === targetCol ? i : -1))
          .filter(i => i !== -1);
        insertIndex = indices.length ? indices[indices.length - 1] + 1 : tasks.length;
      }

      tasks.splice(insertIndex, 0, dragged);
      save();
      render();
    }

    function moveTaskWithinColumn(taskId, direction) {
      const currentIndex = tasks.findIndex(t => t.id === taskId);
      if (currentIndex < 0) return;

      const col = tasks[currentIndex].col;
      const colIndices = tasks
        .map((t, i) => (t.col === col ? i : -1))
        .filter(i => i !== -1);

      const pos = colIndices.indexOf(currentIndex);
      const targetPos = direction === 'up' ? pos - 1 : pos + 1;
      if (targetPos < 0 || targetPos >= colIndices.length) return;

      const swapIndex = colIndices[targetPos];
      [tasks[currentIndex], tasks[swapIndex]] = [tasks[swapIndex], tasks[currentIndex]];
      save();
      render();
    }

    // cross-column movement is handled by drag/drop on column dropzones

    function card(t, focus){
      const el = document.createElement('article');
      el.className = 'card';
      if (focus && focus.id === t.id) el.classList.add('focus-card');
      el.draggable = DRAG_ENABLED;
      el.dataset.id = t.id;
      el.dataset.col = t.col;
      el.innerHTML = `<div>${t.text}</div><div class="meta"><span class="badge ${t.col==='done'?'done':t.priority}">${t.col==='done'?'done':t.priority}</span><div style="display:flex; gap:6px;"><button data-up="${t.id}" title="Move up" style="padding:2px 8px">â†‘</button><button data-down="${t.id}" title="Move down" style="padding:2px 8px">â†“</button><button data-del="${t.id}" style="padding:2px 8px">âœ•</button></div></div>`;

      if (DRAG_ENABLED) {
        // Drag is only for moving tasks across columns (drop onto column dropzones).
        // In-column ordering is intentionally arrow-only for reliability.
        el.addEventListener('dragstart', e => {
          draggedTaskId = t.id;
          e.dataTransfer.setData('text/plain', t.id);
        });
      }

      el.querySelector('[data-up]')?.addEventListener('click', () => moveTaskWithinColumn(t.id, 'up'));
      el.querySelector('[data-down]')?.addEventListener('click', () => moveTaskWithinColumn(t.id, 'down'));
      el.querySelector('[data-del]')?.addEventListener('click', () => {
        tasks = tasks.filter(x => x.id !== t.id); save(); render();
      });
      return el;
    }

    function setGitStatus(text){
      const el = document.getElementById('gitStatus');
      if (el) el.textContent = text;
    }

    function getGithubToken(){
      const existing = localStorage.getItem(GITHUB_TOKEN_KEY) || '';
      const token = prompt('Enter GitHub token with repo scope (stored only in this browser):', existing);
      if (!token) return null;
      localStorage.setItem(GITHUB_TOKEN_KEY, token.trim());
      return token.trim();
    }

    function toBase64Unicode(str){
      return btoa(unescape(encodeURIComponent(str)));
    }

    function fingerprintTasks(list){
      return JSON.stringify(list);
    }

    async function pullFromGitHub(silent = false){
      if (!silent) setGitStatus('Pulling from GitHub...');
      try {
        const res = await fetch(`${GITHUB_DATA_PATH}?ts=${Date.now()}`, { cache: 'no-store' });
        if (!res.ok) throw new Error('No live sync file found yet. Push once first.');
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error('Invalid kanban-data.json format');

        const remoteFp = fingerprintTasks(data);
        const prevFp = localStorage.getItem(REMOTE_FINGERPRINT_KEY) || '';

        if (remoteFp !== prevFp) {
          tasks = data;
          save();
          render();
          localStorage.setItem(REMOTE_FINGERPRINT_KEY, remoteFp);
          setGitStatus(silent ? 'Auto-synced latest GitHub live state' : 'Pulled latest live state from GitHub');
        } else if (!silent) {
          setGitStatus('Already up to date with GitHub live state');
        }
      } catch (e) {
        if (!silent) {
          setGitStatus(`Pull failed: ${e.message}`);
          alert(`GitHub pull failed: ${e.message}`);
        }
      }
    }

    async function pushToGitHub(){
      const token = getGithubToken();
      if (!token) return;

      setGitStatus('Pushing live state to GitHub...');
      const apiBase = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_DATA_PATH}`;

      try {
        let sha = null;
        const existingRes = await fetch(apiBase + `?ref=${GITHUB_BRANCH}`, {
          headers: { Authorization: `Bearer ${token}`, Accept: 'application/vnd.github+json' }
        });
        if (existingRes.ok) {
          const existing = await existingRes.json();
          sha = existing.sha || null;
        }

        const payload = {
          message: `sync: kanban live state ${new Date().toISOString()}`,
          content: toBase64Unicode(JSON.stringify(tasks, null, 2)),
          branch: GITHUB_BRANCH,
          sha
        };

        const putRes = await fetch(apiBase, {
          method: 'PUT',
          headers: {
            Authorization: `Bearer ${token}`,
            Accept: 'application/vnd.github+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (!putRes.ok) {
          const errText = await putRes.text();
          throw new Error(`GitHub API ${putRes.status}: ${errText.slice(0,180)}`);
        }

        localStorage.setItem(REMOTE_FINGERPRINT_KEY, fingerprintTasks(tasks));
        setGitStatus('Pushed live state to GitHub âœ…');
        alert('Live board synced to GitHub (kanban-data.json). Other open boards will auto-refresh shortly.');
      } catch (e) {
        setGitStatus(`Push failed: ${e.message}`);
        alert(`GitHub push failed: ${e.message}`);
      }
    }

    document.getElementById('addBtn').onclick = () => {
      const text = document.getElementById('newTask').value.trim();
      const priority = document.getElementById('newPriority').value;
      if(!text) return;
      tasks.unshift({ id:uid(), text, priority, col: priority==='high' ? 'high' : 'backlog', createdAt: Date.now() });
      document.getElementById('newTask').value='';
      save(); render();
    };

    document.getElementById('newTask').addEventListener('keydown', e => { if(e.key==='Enter') document.getElementById('addBtn').click(); });

    document.getElementById('resetBtn').onclick = () => {
      if(confirm('Reset board to latest seeded task list? This overwrites local changes.')){
        tasks = initialState(); save(); render();
      }
    };

    document.getElementById('exportBtn').onclick = () => {
      const blob = new Blob([JSON.stringify(tasks,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'aadi-kanban-export.json';
      a.click();
      URL.revokeObjectURL(a.href);
    };

    document.getElementById('importBtn').onclick = async () => {
      const picker = document.createElement('input');
      picker.type = 'file';
      picker.accept = 'application/json,.json';
      picker.onchange = async () => {
        const file = picker.files?.[0];
        if (!file) return;
        try {
          const text = await file.text();
          const data = JSON.parse(text);
          if (!Array.isArray(data)) throw new Error('Invalid format');
          const valid = data.every(t => t && typeof t.id === 'string' && typeof t.text === 'string' && typeof t.col === 'string');
          if (!valid) throw new Error('Invalid task schema');
          tasks = data;
          save();
          render();
          alert('Kanban imported successfully.');
        } catch (e) {
          alert('Import failed. Please use a valid exported Kanban JSON file.');
        }
      };
      picker.click();
    };

    document.getElementById('pullGitBtn').onclick = pullFromGitHub;
    document.getElementById('pushGitBtn').onclick = pushToGitHub;

    window.addEventListener('resize', render);

    render();
    // best-effort auto-load of live GitHub state if available
    pullFromGitHub(true);
    // auto-refresh from GitHub so other devices update after a push
    setInterval(() => pullFromGitHub(true), AUTO_PULL_MS);
  </script>
</body>
</html>